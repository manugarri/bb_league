{% extends "base.html" %}

{% block title %}{{ match.home_team.name }} vs {{ match.away_team.name }} - Blood Bowl League Tracker{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('matches.index') }}">{{ _('Matches') }}</a></li>
        {% if match.league %}
        <li class="breadcrumb-item"><a href="{{ url_for('leagues.view', league_id=match.league.id) }}">{{ match.league.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item active">{% if get_locale() == 'es' %}Detalles del Partido{% else %}Match Details{% endif %}</li>
    </ol>
</nav>

<!-- Match Header -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center text-center">
            <!-- Home Team -->
            <div class="col-md-4">
                <a href="{{ url_for('teams.view', team_id=match.home_team.id) }}" class="text-decoration-none">
                    <h3 class="{% if match.is_completed and match.home_score > match.away_score %}text-gold{% else %}text-light{% endif %} mb-1">
                        {{ match.home_team.name }}
                    </h3>
                </a>
                <span class="badge bg-secondary">{{ match.home_team.race.name }}</span>
                <p class="text-muted small mb-0 mt-1">{{ match.home_team.coach.username }}</p>
            </div>
            
            <!-- Score -->
            <div class="col-md-4 py-3">
                {% if match.is_completed %}
                <div class="display-3 fw-bold">
                    <span class="{% if match.home_score > match.away_score %}text-gold{% endif %}">{{ match.home_score }}</span>
                    <span class="text-muted mx-2">-</span>
                    <span class="{% if match.away_score > match.home_score %}text-gold{% endif %}">{{ match.away_score }}</span>
                </div>
                <span class="badge bg-success mt-2">{% if get_locale() == 'es' %}Completado{% else %}Completed{% endif %}</span>
                {% else %}
                <div class="display-5 text-muted">VS</div>
                <span class="badge bg-warning mt-2">{% if get_locale() == 'es' %}{% if match.status == 'scheduled' %}Programado{% elif match.status == 'in_progress' %}En Curso{% else %}{{ match.status | capitalize }}{% endif %}{% else %}{{ match.status | capitalize }}{% endif %}</span>
                {% endif %}
                
                {% if match.league %}
                <p class="text-muted small mt-2 mb-0">
                    {{ match.league.name }} · {% if get_locale() == 'es' %}Jornada{% else %}Round{% endif %} {{ match.round_number or 'N/A' }}
                </p>
                {% endif %}
            </div>
            
            <!-- Away Team -->
            <div class="col-md-4">
                <a href="{{ url_for('teams.view', team_id=match.away_team.id) }}" class="text-decoration-none">
                    <h3 class="{% if match.is_completed and match.away_score > match.home_score %}text-gold{% else %}text-light{% endif %} mb-1">
                        {{ match.away_team.name }}
                    </h3>
                </a>
                <span class="badge bg-secondary">{{ match.away_team.race.name }}</span>
                <p class="text-muted small mb-0 mt-1">{{ match.away_team.coach.username }}</p>
            </div>
        </div>
        
        <div class="text-center mt-4">
            {% if match.status == 'scheduled' or match.status == 'prematch' %}
            <!-- Pre-match Activities Button -->
            <a href="{{ url_for('prematch.index', match_id=match.id) }}" class="btn btn-secondary btn-lg me-2">
                <i class="bi bi-clipboard-check me-2"></i>{% if get_locale() == 'es' %}Actividades Pre-Partido{% else %}Pre-Match Activities{% endif %}
                {% if match.home_prematch_ready and match.away_prematch_ready %}
                <span class="badge bg-success ms-1">✓</span>
                {% elif match.home_prematch_ready or match.away_prematch_ready %}
                <span class="badge bg-warning ms-1">1/2</span>
                {% endif %}
            </a>
            {% endif %}
            
            {% if can_record and match.is_prematch_complete %}
            <a href="{{ url_for('matches.record', match_id=match.id) }}" class="btn btn-primary btn-lg me-2">
                <i class="bi bi-pencil-square me-2"></i>{% if get_locale() == 'es' %}Registrar Resultado{% else %}Record Result{% endif %}
            </a>
            {% elif can_record and match.status == 'in_progress' %}
            <a href="{{ url_for('matches.record', match_id=match.id) }}" class="btn btn-primary btn-lg me-2">
                <i class="bi bi-pencil-square me-2"></i>{% if get_locale() == 'es' %}Registrar Resultado{% else %}Record Result{% endif %}
            </a>
            {% endif %}
            
            {% if not match.is_completed %}
            {% set user_team_ids = current_user.teams | map(attribute='id') | list %}
            {% if match.home_team_id not in user_team_ids and match.away_team_id not in user_team_ids %}
            {% set existing_bet = current_user.bets.filter_by(match_id=match.id).first() %}
            {% if existing_bet %}
            <a href="{{ url_for('bets.view_bet', bet_id=existing_bet.id) }}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-cash-coin me-2"></i>{% if get_locale() == 'es' %}Ver Apuesta{% else %}View Bet{% endif %}
            </a>
            {% else %}
            <div class="btn-group">
                <button type="button" class="btn btn-secondary btn-lg dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-cash-coin me-2"></i>{% if get_locale() == 'es' %}Apostar{% else %}Place Bet{% endif %}
                </button>
                <ul class="dropdown-menu dropdown-menu-dark">
                    <li>
                        <a class="dropdown-item" href="{{ url_for('bets.place_bet', match_id=match.id) }}">
                            <i class="bi bi-cash-stack me-2 text-warning"></i>
                            {% if get_locale() == 'es' %}Apuesta Estándar{% else %}Standard Bet{% endif %}
                            <br>
                            <small class="text-muted">{% if get_locale() == 'es' %}Multiplicadores fijos (2x, 5x, 7x){% else %}Fixed multipliers (2x, 5x, 7x){% endif %}</small>
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('bets.ai_bet_match', match_id=match.id) }}">
                            <i class="bi bi-robot me-2 text-primary"></i>
                            {% if get_locale() == 'es' %}Apuesta IA{% else %}AI Bet{% endif %}
                            <br>
                            <small class="text-muted">{% if get_locale() == 'es' %}Multiplicador calculado por IA{% else %}AI-calculated multiplier{% endif %}</small>
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>

{% if match.status == 'scheduled' and not match.is_prematch_complete %}
<!-- Pre-Match Alert -->
<div class="alert alert-info mb-4">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="bi bi-clipboard-check fs-3"></i>
        </div>
        <div class="flex-grow-1">
            <h5 class="mb-1">{% if get_locale() == 'es' %}Actividades Pre-Partido Pendientes{% else %}Pre-Match Activities Pending{% endif %}</h5>
            <p class="mb-0">
                {% if get_locale() == 'es' %}
                Antes de jugar el partido, ambos equipos deben completar sus actividades pre-partido (incentivos).
                {% else %}
                Before playing the match, both teams must complete their pre-match activities (inducements).
                {% endif %}
            </p>
            <div class="mt-2">
                <span class="badge {% if match.home_prematch_ready %}bg-success{% else %}bg-warning{% endif %} me-2">
                    {{ match.home_team.name }}: {% if match.home_prematch_ready %}{% if get_locale() == 'es' %}Listo{% else %}Ready{% endif %}{% else %}{% if get_locale() == 'es' %}Pendiente{% else %}Pending{% endif %}{% endif %}
                </span>
                <span class="badge {% if match.away_prematch_ready %}bg-success{% else %}bg-warning{% endif %}">
                    {{ match.away_team.name }}: {% if match.away_prematch_ready %}{% if get_locale() == 'es' %}Listo{% else %}Ready{% endif %}{% else %}{% if get_locale() == 'es' %}Pendiente{% else %}Pending{% endif %}{% endif %}
                </span>
            </div>
        </div>
        <a href="{{ url_for('prematch.index', match_id=match.id) }}" class="btn btn-info">
            <i class="bi bi-arrow-right me-2"></i>{% if get_locale() == 'es' %}Ver Pre-Partido{% else %}View Pre-Match{% endif %}
        </a>
    </div>
</div>
{% elif match.is_prematch_complete and not match.is_completed %}
<!-- Pre-Match Complete Alert -->
<div class="alert alert-success mb-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-check-circle-fill me-2 fs-4"></i>
        <span>
            {% if get_locale() == 'es' %}
            ¡Actividades pre-partido completadas! El partido puede comenzar.
            {% else %}
            Pre-match activities completed! The match can begin.
            {% endif %}
        </span>
    </div>
</div>
{% endif %}

{% if match.is_completed %}
<!-- Match Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-house me-2"></i>{{ match.home_team.name }} {% if get_locale() == 'es' %}Estadísticas{% else %}Stats{% endif %}
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <td>Touchdowns</td>
                        <td class="text-end text-gold fw-bold">{{ match.home_score }}</td>
                    </tr>
                    <tr>
                        <td>{% if get_locale() == 'es' %}Bajas Infligidas{% else %}Casualties Inflicted{% endif %}</td>
                        <td class="text-end">{{ match.home_casualties }}</td>
                    </tr>
                    <tr>
                        <td>{% if get_locale() == 'es' %}Ganancias{% else %}Winnings{% endif %}</td>
                        <td class="text-end text-gold">{{ "{:,}".format(match.home_winnings) }}g</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-airplane me-2"></i>{{ match.away_team.name }} {% if get_locale() == 'es' %}Estadísticas{% else %}Stats{% endif %}
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <td>Touchdowns</td>
                        <td class="text-end text-gold fw-bold">{{ match.away_score }}</td>
                    </tr>
                    <tr>
                        <td>{% if get_locale() == 'es' %}Bajas Infligidas{% else %}Casualties Inflicted{% endif %}</td>
                        <td class="text-end">{{ match.away_casualties }}</td>
                    </tr>
                    <tr>
                        <td>{% if get_locale() == 'es' %}Ganancias{% else %}Winnings{% endif %}</td>
                        <td class="text-end text-gold">{{ "{:,}".format(match.away_winnings) }}g</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Player Stats -->
<div class="row g-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people me-2"></i>{{ match.home_team.name }} {% if get_locale() == 'es' %}Jugadores{% else %}Players{% endif %}
            </div>
            <div class="card-body p-0">
                {% if home_stats %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>{% if get_locale() == 'es' %}Jugador{% else %}Player{% endif %}</th>
                                <th class="text-center">TD</th>
                                <th class="text-center">{% if get_locale() == 'es' %}BAJ{% else %}CAS{% endif %}</th>
                                <th class="text-center">{% if get_locale() == 'es' %}PAS{% else %}COMP{% endif %}</th>
                                <th class="text-center">INT</th>
                                <th class="text-center">MVP</th>
                                <th class="text-center">{% if get_locale() == 'es' %}PE{% else %}SPP{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in home_stats %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('teams.view_player', team_id=match.home_team.id, player_id=stat.player.id) }}" class="text-decoration-none text-light">
                                        {{ stat.player.name }}
                                    </a>
                                    {% if stat.injury_result %}
                                    <span class="badge bg-danger ms-1">{{ stat.injury_result | upper }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if stat.touchdowns > 0 %}text-gold fw-bold{% endif %}">{{ stat.touchdowns }}</td>
                                <td class="text-center {% if stat.casualties_inflicted > 0 %}text-danger{% endif %}">{{ stat.casualties_inflicted }}</td>
                                <td class="text-center">{{ stat.completions }}</td>
                                <td class="text-center">{{ stat.interceptions }}</td>
                                <td class="text-center">{% if stat.is_mvp %}<i class="bi bi-star-fill text-gold"></i>{% endif %}</td>
                                <td class="text-center text-gold">{{ stat.spp_earned }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    {% if get_locale() == 'es' %}No hay estadísticas de jugadores registradas.{% else %}No player statistics recorded.{% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people me-2"></i>{{ match.away_team.name }} {% if get_locale() == 'es' %}Jugadores{% else %}Players{% endif %}
            </div>
            <div class="card-body p-0">
                {% if away_stats %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>{% if get_locale() == 'es' %}Jugador{% else %}Player{% endif %}</th>
                                <th class="text-center">TD</th>
                                <th class="text-center">{% if get_locale() == 'es' %}BAJ{% else %}CAS{% endif %}</th>
                                <th class="text-center">{% if get_locale() == 'es' %}PAS{% else %}COMP{% endif %}</th>
                                <th class="text-center">INT</th>
                                <th class="text-center">MVP</th>
                                <th class="text-center">{% if get_locale() == 'es' %}PE{% else %}SPP{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in away_stats %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('teams.view_player', team_id=match.away_team.id, player_id=stat.player.id) }}" class="text-decoration-none text-light">
                                        {{ stat.player.name }}
                                    </a>
                                    {% if stat.injury_result %}
                                    <span class="badge bg-danger ms-1">{{ stat.injury_result | upper }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if stat.touchdowns > 0 %}text-gold fw-bold{% endif %}">{{ stat.touchdowns }}</td>
                                <td class="text-center {% if stat.casualties_inflicted > 0 %}text-danger{% endif %}">{{ stat.casualties_inflicted }}</td>
                                <td class="text-center">{{ stat.completions }}</td>
                                <td class="text-center">{{ stat.interceptions }}</td>
                                <td class="text-center">{% if stat.is_mvp %}<i class="bi bi-star-fill text-gold"></i>{% endif %}</td>
                                <td class="text-center text-gold">{{ stat.spp_earned }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    {% if get_locale() == 'es' %}No hay estadísticas de jugadores registradas.{% else %}No player statistics recorded.{% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if match.notes %}
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-journal-text me-2"></i>{% if get_locale() == 'es' %}Notas del Partido{% else %}Match Notes{% endif %}
    </div>
    <div class="card-body">
        <p class="mb-0">{{ match.notes }}</p>
    </div>
</div>
{% endif %}

<!-- Inducements Section (if any were purchased) -->
{% set home_inducements = match.get_team_inducements(match.home_team_id) %}
{% set away_inducements = match.get_team_inducements(match.away_team_id) %}
{% if home_inducements or away_inducements %}
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-cart-check me-2"></i>{% if get_locale() == 'es' %}Incentivos{% else %}Inducements{% endif %}
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-gold">{{ match.home_team.name }}</h6>
                {% if home_inducements %}
                <ul class="list-unstyled mb-0">
                    {% for ind in home_inducements %}
                    <li class="d-flex justify-content-between">
                        <span>{{ ind.inducement_name }}{% if ind.quantity > 1 %} x{{ ind.quantity }}{% endif %}</span>
                        <span class="text-muted">{{ "{:,}".format(ind.total_cost) }}g</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted small mb-0">{% if get_locale() == 'es' %}Sin incentivos{% else %}No inducements{% endif %}</p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h6 class="text-gold">{{ match.away_team.name }}</h6>
                {% if away_inducements %}
                <ul class="list-unstyled mb-0">
                    {% for ind in away_inducements %}
                    <li class="d-flex justify-content-between">
                        <span>{{ ind.inducement_name }}{% if ind.quantity > 1 %} x{{ ind.quantity }}{% endif %}</span>
                        <span class="text-muted">{{ "{:,}".format(ind.total_cost) }}g</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted small mb-0">{% if get_locale() == 'es' %}Sin incentivos{% else %}No inducements{% endif %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Pending AI Bets Alert (for match recorders) -->
{% set pending_ai_bets = match.bets.filter_by(bet_type='ai_custom', status='pending').count() %}
{% if pending_ai_bets > 0 %}
{% set is_home_coach = current_user.id == match.home_team.coach_id %}
{% set is_away_coach = current_user.id == match.away_team.coach_id %}
{% set is_commissioner = match.league and current_user.id == match.league.commissioner_id %}
{% if is_home_coach or is_away_coach or is_commissioner or current_user.is_admin %}
<div class="alert alert-warning mt-4 d-flex justify-content-between align-items-center">
    <div>
        <i class="bi bi-robot me-2"></i>
        {% if get_locale() == 'es' %}
        <strong>{{ pending_ai_bets }}</strong> apuesta(s) IA pendiente(s) de confirmación.
        {% else %}
        <strong>{{ pending_ai_bets }}</strong> AI bet(s) pending confirmation.
        {% endif %}
    </div>
    <a href="{{ url_for('matches.confirm_ai_bets', match_id=match.id) }}" class="btn btn-warning">
        <i class="bi bi-check-circle me-2"></i>
        {% if get_locale() == 'es' %}Confirmar Apuestas{% else %}Confirm Bets{% endif %}
    </a>
</div>
{% endif %}
{% endif %}

{% endif %}
{% endblock %}

